<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracker - Home Edition (Supabase Synchronized)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gray-color: #7f8c8d;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
            direction: ltr;
        }

        /* Arabic text styling - ALL BOLD - UPDATED FOR REPORTS */
        .arabic-text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold !important;
            direction: rtl;
        }

        /* Bold Arabic font for all Arabic text */
        [lang="ar"], [dir="rtl"] {
            font-weight: bold !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        /* Report table Arabic text - NEW STYLE */
        .report-arabic {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            font-weight: bold !important;
            direction: rtl;
        }

        /* Arabic text in chart - NEW STYLE */
        .chart-arabic {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            font-weight: bold !important;
        }

        /* Header and main screen */
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }

        .header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.8rem;
        }

        /* Main screen with 4 values */
        .main-screen {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .balance-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px 15px;
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: var(--transition);
            border-top: 4px solid var(--secondary-color);
        }

        .balance-card:hover {
            transform: translateY(-5px);
        }

        .balance-card:nth-child(2) {
            border-top-color: var(--success-color);
        }

        .balance-card:nth-child(3) {
            border-top-color: var(--warning-color);
        }

        .balance-card:nth-child(4) {
            border-top-color: var(--accent-color);
        }

        .balance-card h3 {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 10px;
        }

        .balance-card .amount {
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .positive {
            color: var(--success-color) !important;
        }

        .negative {
            color: var(--accent-color) !important;
        }

        /* Main menu buttons */
        .main-menu {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .main-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 15px 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .main-btn i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .main-btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-3px);
        }

        .main-btn.active {
            background-color: var(--secondary-color);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
        }

        /* Submenu container */
        .submenu-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .submenu-container.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .submenu-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* Form styling */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-info {
            background-color: var(--gray-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #6c7b7d;
        }

        /* Navigation buttons */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .nav-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-btn:hover {
            background-color: #e9ecef;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Data management section */
        .data-management {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .data-management .submenu-title {
            grid-column: 1 / -1;
        }

        /* PDF date range controls */
        .pdf-date-range {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }

        .pdf-date-range h4 {
            grid-column: 1 / -1;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* Reports section */
        .report-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 30px;
            position: relative;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        /* Group header in reports table */
        .group-header {
            font-weight: bold;
            font-size: 1.1rem;
            border-left: 5px solid;
        }

        .group-total {
            font-weight: bold;
            background-color: #f8f9fa;
        }

        /* Settings section */
        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .settings-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* Transfer list table */
        .transfers-list {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        .transfers-list h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-screen {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-menu {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .main-btn {
                font-size: 0.9rem;
                padding: 12px 5px;
            }
            
            .main-btn i {
                font-size: 1.2rem;
            }
            
            .data-management {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pdf-date-range {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .main-screen {
                grid-template-columns: 1fr;
            }
            
            .main-menu {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .data-management {
                grid-template-columns: 1fr;
            }
            
            .pdf-date-range {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: bold;
            z-index: 1000;
            box-shadow: var(--box-shadow);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--accent-color);
        }

        .notification.info {
            background-color: var(--secondary-color);
        }

        /* Modal for confirmation */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> Financial Tracker - Home Edition</h1>
        <p class="arabic-text" dir="rtl" lang="ar">ÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ™ŸÉÿßŸÖŸÑ ŸÑÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ŸàÿßŸÑÿØÿÆŸÑ ŸàÿßŸÑÿ™ÿ≠ŸàŸäŸÑÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©</p>
    </div>

    <div class="main-screen">
        <div class="balance-card">
            <h3>OVERALL NET BALANCE</h3>
            <div class="amount" id="net-balance">$0.00</div>
        </div>
        <div class="balance-card">
            <h3>Balance (safe1)</h3>
            <div class="amount" id="balance-safe1">$0.00</div>
        </div>
        <div class="balance-card">
            <h3>Balance (safe2)</h3>
            <div class="amount" id="balance-safe2">$0.00</div>
        </div>
        <div class="balance-card">
            <h3>Total Expenses (All Safes)</h3>
            <div class="amount" id="total-expenses">$0.00</div>
        </div>
    </div>

    <div class="main-menu">
        <button class="main-btn active" data-submenu="expense">
            <i class="fas fa-money-bill-wave"></i>
            <span>Expense</span>
        </button>
        <button class="main-btn" data-submenu="income">
            <i class="fas fa-hand-holding-usd"></i>
            <span>Income</span>
        </button>
        <button class="main-btn" data-submenu="transfer">
            <i class="fas fa-exchange-alt"></i>
            <span>Transfer</span>
        </button>
        <button class="main-btn" data-submenu="reports">
            <i class="fas fa-chart-pie"></i>
            <span>Reports</span>
        </button>
        <button class="main-btn" data-submenu="settings">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </button>
    </div>

    <div class="submenu-container active" id="expense-submenu">
        <h2 class="submenu-title"><i class="fas fa-money-bill-wave"></i> Expense Management</h2>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="expense-new">
                <i class="fas fa-plus"></i> New
            </button>
            <button class="btn btn-success" id="expense-save">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-danger" id="expense-delete">
                <i class="fas fa-trash"></i> Delete
            </button>
            <div style="display: flex; gap: 10px; margin-left: auto;">
                <button class="nav-btn" id="expense-prev">
                    <i class="fas fa-chevron-left"></i> Prev
                </button>
                <button class="nav-btn" id="expense-next">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="expense-number">Number</label>
                <input type="text" id="expense-number" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="expense-date">Date</label>
                <input type="date" id="expense-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="expense-value">Value</label>
                <input type="number" id="expense-value" class="form-control" step="0.01" min="0" value="2400">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="expense-main-type">Main Expense Type</label>
                <input type="text" id="expense-main-type" class="form-control arabic-text" list="expense-main-types" value="ŸÖÿµÿßÿ±ŸäŸÅ ÿπŸÖÿßÿ±ÿ©" dir="rtl">
                <datalist id="expense-main-types">
                    <option class="arabic-text" value="ŸÖÿµÿßÿ±ŸäŸÅ ÿπŸÖÿßÿ±ÿ©"></option>
                    <option class="arabic-text" value="ŸÅŸàÿßÿ™Ÿäÿ±"></option>
                    <option class="arabic-text" value="ŸÖŸàÿßÿµŸÑÿßÿ™"></option>
                    <option class="arabic-text" value="ÿ™ÿ≥ŸàŸÇ"></option>
                    <option class="arabic-text" value="ÿµÿ≠ÿ©"></option>
                    <option class="arabic-text" value="ÿ™ÿπŸÑŸäŸÖ"></option>
                </datalist>
            </div>
            <div class="form-group">
                <label for="expense-sub-type">Sub Expense Type</label>
                <input type="text" id="expense-sub-type" class="form-control arabic-text" list="expense-sub-types" value="ÿ™ÿÆŸÑŸäŸÅ" dir="rtl">
                <datalist id="expense-sub-types">
                    <option class="arabic-text" value="ÿ™ÿÆŸÑŸäŸÅ"></option>
                    <option class="arabic-text" value="ŸÉŸáÿ±ÿ®ÿßÿ°"></option>
                    <option class="arabic-text" value="ŸÖÿßÿ°"></option>
                    <option class="arabic-text" value="ÿ∫ÿßÿ≤"></option>
                    <option class="arabic-text" value="ÿ•ŸÜÿ™ÿ±ŸÜÿ™"></option>
                </datalist>
            </div>
            <div class="form-group">
                <label for="expense-safe">Safe</label>
                <select id="expense-safe" class="form-control">
                    <option value="">Select Safe</option>
                </select>
            </div>
        </div>
    </div>

    <div class="submenu-container" id="income-submenu">
        <h2 class="submenu-title"><i class="fas fa-hand-holding-usd"></i> Income Management</h2>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="income-new">
                <i class="fas fa-plus"></i> New
            </button>
            <button class="btn btn-success" id="income-save">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-danger" id="income-delete">
                <i class="fas fa-trash"></i> Delete
            </button>
            <div style="display: flex; gap: 10px; margin-left: auto;">
                <button class="nav-btn" id="income-prev">
                    <i class="fas fa-chevron-left"></i> Prev
                </button>
                <button class="nav-btn" id="income-next">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="income-number">Number</label>
                <input type="text" id="income-number" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="income-date">Date</label>
                <input type="date" id="income-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="income-value">Value</label>
                <input type="number" id="income-value" class="form-control" step="0.01" min="0">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="income-main-type">Main Income Type</label>
                <input type="text" id="income-main-type" class="form-control" list="income-main-types">
                <datalist id="income-main-types"></datalist>
            </div>
            <div class="form-group">
                <label for="income-sub-type">Sub Income Type</label>
                <input type="text" id="income-sub-type" class="form-control" list="income-sub-types">
                <datalist id="income-sub-types"></datalist>
            </div>
            <div class="form-group">
                <label for="income-safe">Safe</label>
                <select id="income-safe" class="form-control">
                    <option value="">Select Safe</option>
                </select>
            </div>
        </div>
    </div>

    <div class="submenu-container" id="transfer-submenu">
        <h2 class="submenu-title"><i class="fas fa-exchange-alt"></i> Transfer Management</h2>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="transfer-new">
                <i class="fas fa-plus"></i> New
            </button>
            <button class="btn btn-success" id="transfer-save">
                <i class="fas fa-save"></i> Save
            </button>
            <button class="btn btn-danger" id="transfer-delete">
                <i class="fas fa-trash"></i> Delete
            </button>
            <div style="display: flex; gap: 10px; margin-left: auto;">
                <button class="nav-btn" id="transfer-prev">
                    <i class="fas fa-chevron-left"></i> Prev
                </button>
                <button class="nav-btn" id="transfer-next">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="transfer-date">Date</label>
                <input type="date" id="transfer-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="transfer-from">Transfer From Safe</label>
                <select id="transfer-from" class="form-control">
                    <option value="">Select Safe</option>
                </select>
            </div>
            <div class="form-group">
                <label for="transfer-to">Transfer To Safe</label>
                <select id="transfer-to" class="form-control">
                    <option value="">Select Safe</option>
                </select>
            </div>
            <div class="form-group">
                <label for="transfer-value">Transfer Value</label>
                <input type="number" id="transfer-value" class="form-control" step="0.01" min="0">
            </div>
        </div>
        
        <div class="transfers-list">
            <h3><i class="fas fa-list"></i> All Transfers</h3>
            <div class="table-container">
                <table id="transfers-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>From Safe</th>
                            <th>To Safe</th>
                            <th>Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transfers-table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="submenu-container" id="reports-submenu">
        <h2 class="submenu-title"><i class="fas fa-chart-pie"></i> Reports</h2>
        
        <div class="report-controls">
            <div class="form-group">
                <label for="report-from-date">From Date</label>
                <input type="date" id="report-from-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="report-to-date">To Date</label>
                <input type="date" id="report-to-date" class="form-control">
            </div>
            <div class="form-group">
                <label for="report-main-type">Main Type</label>
                <select id="report-main-type" class="form-control">
                    <option value="">All Types</option>
                </select>
            </div>
            <div class="form-group">
                <label for="report-sub-type">Sub Type</label>
                <select id="report-sub-type" class="form-control">
                    <option value="">All Sub Types</option>
                </select>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="report-expense">
                <i class="fas fa-money-bill-wave"></i> Expense Report
            </button>
            <button class="btn btn-success" id="report-income">
                <i class="fas fa-hand-holding-usd"></i> Income Report
            </button>
            <button class="btn btn-info" id="report-clear">
                <i class="fas fa-broom"></i> Clear
            </button>
        </div>
        
        <div class="chart-container">
            <canvas id="report-chart"></canvas>
        </div>
        
        <div class="table-container">
            <table id="report-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Main Type</th>
                        <th>Sub Type</th>
                        <th>Safe</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="report-table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="submenu-container" id="settings-submenu">
        <h2 class="submenu-title"><i class="fas fa-cog"></i> Settings</h2>
        
        <div class="settings-section">
            <h3><i class="fas fa-vault"></i> Safes Management</h3>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="safe-new">
                    <i class="fas fa-plus"></i> New
                </button>
                <button class="btn btn-success" id="safe-save">
                    <i class="fas fa-save"></i> Save
                </button>
                <button class="btn btn-danger" id="safe-delete">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button class="nav-btn" id="safe-prev">
                        <i class="fas fa-chevron-left"></i> Prev
                    </button>
                    <button class="nav-btn" id="safe-next">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="safe-name">Safe Name</label>
                    <input type="text" id="safe-name" class="form-control">
                </div>
                <div class="form-group">
                    <label for="safe-initial-balance">Initial Balance</label>
                    <input type="number" id="safe-initial-balance" class="form-control" step="0.01" value="0">
                </div>
            </div>
            
            <div class="form-group">
                <label for="all-safes">All Safes</label>
                <select id="all-safes" class="form-control" multiple size="5">
                </select>
            </div>
        </div>
        
        <div class="settings-section">
            <h3><i class="fas fa-money-bill"></i> Currency & Data Backup</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="currency-symbol">Currency Symbol</label>
                    <input type="text" id="currency-symbol" class="form-control" value="$">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label for="data-backup-note">Data Note (Supabase Sync)</label>
                    <p style="font-size: 0.9em; color: gray; margin-top: 5px;">Your primary data is stored on Supabase. Backup is local (JSON).</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-info" id="save-currency">
                    <i class="fas fa-save"></i> Save Currency
                </button>
                <button class="btn btn-warning" id="backup-data">
                    <i class="fas fa-download"></i> Backup Local Data
                </button>
                <button class="btn btn-danger" id="restore-data">
                    <i class="fas fa-upload"></i> Restore Local Data
                </button>
                <input type="file" id="restore-file" style="display: none;" accept=".json">
            </div>
        </div>
        
        <div class="settings-section">
            <h3><i class="fas fa-tags"></i> Expense/Income Types (Local Cache)</h3>
            <p style="font-size: 0.9em; color: gray; margin-bottom: 10px;">These lists are used for auto-completion (datalists). They are now stored in a local cache (Supabase table).</p>

            <div class="form-group">
                <label for="expense-types-list">Main Expense Types (Comma Separated)</label>
                <textarea id="expense-types-list" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="expense-sub-types-list">Sub Expense Types (Comma Separated)</label>
                <textarea id="expense-sub-types-list" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="income-types-list">Main Income Types (Comma Separated)</label>
                <textarea id="income-types-list" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="income-sub-types-list">Sub Income Types (Comma Separated)</label>
                <textarea id="income-sub-types-list" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-info" id="save-expense-types">
                    <i class="fas fa-save"></i> Save Expense Types
                </button>
                <button class="btn btn-success" id="save-income-types">
                    <i class="fas fa-save"></i> Save Income Types
                </button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Confirm Restore</h3>
            <p id="modal-text">Are you sure you want to completely overwrite all your data with the selected file? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="modal-confirm">Overwrite All</button>
                <button class="btn btn-info" id="modal-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // üîë SUPABASE CREDENTIALS AND INITIALIZATION
        // The table names are assumed to be 'safes', 'expenses', 'incomes', 'transfers', 'expense_types', 'expense_sub_types', 'income_types', 'income_sub_types'
        const SUPABASE_URL = 'https://slruybozyxidukkbbttc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscnV5Ym96eXhpZHVra2JidHRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzNTk2NzgsImV4cCI6MjA4MDkzNTY3OH0.xlGScYoF7BxwB1HgI3-uJjktTtuxVqfdAkhru1Y_oqM';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // In-memory state management (replaces localStorage for navigation and reports)
        const appState = {
            currency: localStorage.getItem('currency') || '$',
            safes: [],
            expenses: [],
            incomes: [],
            transfers: [],
            expenseTypes: [],
            expenseSubTypes: [],
            incomeTypes: [],
            incomeSubTypes: [],
            currentExpenseIndex: -1,
            currentIncomeIndex: -1,
            currentTransferIndex: -1,
            currentSafeIndex: -1,
            chartInstance: null,
            latestExpenseNumber: 0,
            latestIncomeNumber: 0
        };
        
        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function formatCurrency(value) {
            if (isNaN(value) || value === null) return `${appState.currency}0.00`;
            const formatted = parseFloat(value).toFixed(2);
            return `${appState.currency}${formatted.replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        }
        
        function parseCurrency(valueStr) {
            return parseFloat(valueStr.replace(appState.currency, '').replace(/,/g, '')) || 0;
        }

        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        function isArabicText(text) {
            // Check if text contains any Arabic characters
            return /[\u0600-\u06FF]/.test(text);
        }
        
        // SUPABASE WRAPPER FUNCTIONS (CRUD for Safes, Expenses, etc.)
        
        // --- Safes CRUD ---
        async function fetchSafes() {
            try {
                const { data, error } = await supabase
                    .from('safes')
                    .select('*')
                    .order('id', { ascending: true });
                
                if (error) throw error;
                appState.safes = data || [];
                return appState.safes;
            } catch (error) {
                console.error('Error fetching safes:', error);
                showNotification('Error fetching safes: ' + error.message, 'error');
                return [];
            }
        }

        async function saveSafeRecord(safeData) {
            try {
                let result;
                if (safeData.id) {
                    // Update existing safe
                    result = await supabase
                        .from('safes')
                        .update({ name: safeData.name, initial_balance: safeData.initial_balance })
                        .eq('id', safeData.id)
                        .select();
                } else {
                    // Insert new safe
                    result = await supabase
                        .from('safes')
                        .insert({ name: safeData.name, initial_balance: safeData.initial_balance, current_balance: safeData.initial_balance }) // current_balance set to initial
                        .select();
                }
                
                if (result.error) throw result.error;
                showNotification(`Safe ${safeData.id ? 'updated' : 'added'} successfully`, 'success');
                await loadAllDataAndRefreshUI(); // Refresh all data and UI
                return true;
            } catch (error) {
                console.error('Error saving safe:', error);
                showNotification('Error saving safe: ' + error.message, 'error');
                return false;
            }
        }

        async function deleteSafeRecord(id) {
            try {
                // Check if any transactions (expense, income, transfer) use this safe before deleting
                // In a real scenario, this would involve complex checks. Here we allow deletion for simplicity.
                
                const { error } = await supabase
                    .from('safes')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                showNotification('Safe deleted successfully', 'success');
                appState.currentSafeIndex = Math.min(appState.currentSafeIndex, appState.safes.length - 2);
                await loadAllDataAndRefreshUI();
            } catch (error) {
                console.error('Error deleting safe:', error);
                showNotification('Error deleting safe: ' + error.message, 'error');
            }
        }

        async function updateSafeBalance(safeName, amount, operation) {
            const safe = appState.safes.find(s => s.name === safeName);
            if (!safe) return;

            let newBalance = safe.current_balance;
            if (operation === 'add') {
                newBalance += amount;
            } else if (operation === 'deduct') {
                newBalance -= amount;
            } else if (operation === 'set') {
                 // For complex updates or initial setup, use 'set'
            }

            try {
                const { error } = await supabase
                    .from('safes')
                    .update({ current_balance: newBalance })
                    .eq('id', safe.id);
                
                if (error) throw error;
            } catch (error) {
                console.error(`Error updating balance for ${safeName}:`, error);
                showNotification(`Error updating balance for ${safeName}`, 'error');
            }
        }

        // --- Expense/Income/Transfer CRUD ---
        async function fetchTransactions(table, filters = {}) {
            try {
                let query = supabase.from(table).select('*').order('date', { ascending: false });

                if (filters.mainType) {
                    query = query.eq('main_type', filters.mainType);
                }
                if (filters.subType) {
                    query = query.eq('sub_type', filters.subType);
                }
                if (filters.fromDate && filters.toDate) {
                    query = query.gte('date', filters.fromDate).lte('date', filters.toDate);
                }
                
                const { data, error } = await query;
                if (error) throw error;
                
                // Set the in-memory state based on the table name
                if (table === 'expenses') appState.expenses = data || [];
                if (table === 'incomes') appState.incomes = data || [];
                if (table === 'transfers') appState.transfers = data || [];

                return data || [];
            } catch (error) {
                console.error(`Error fetching ${table}:`, error);
                showNotification(`Error fetching ${table}: ${error.message}`, 'error');
                return [];
            }
        }

        async function saveTransaction(table, record) {
            try {
                let result;
                if (record.id) {
                    // Update existing record
                    result = await supabase
                        .from(table)
                        .update(record)
                        .eq('id', record.id)
                        .select();
                } else {
                    // Insert new record
                    result = await supabase
                        .from(table)
                        .insert(record)
                        .select();
                }

                if (result.error) throw result.error;
                showNotification(`${table} record ${record.id ? 'updated' : 'added'} successfully`, 'success');
                await loadAllDataAndRefreshUI();
                return result.data[0];
            } catch (error) {
                console.error(`Error saving ${table}:`, error);
                showNotification(`Error saving ${table}: ${error.message}`, 'error');
                return null;
            }
        }

        async function deleteTransaction(table, id) {
             try {
                const { error } = await supabase
                    .from(table)
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                showNotification(`${table} record deleted successfully`, 'success');
                await loadAllDataAndRefreshUI();
            } catch (error) {
                console.error(`Error deleting ${table}:`, error);
                showNotification(`Error deleting ${table}: ${error.message}`, 'error');
            }
        }

        // --- Types CRUD ---
        async function fetchTypes(table) {
            try {
                const { data, error } = await supabase
                    .from(table)
                    .select('name')
                    .order('name', { ascending: true });
                
                if (error) throw error;
                return (data || []).map(item => item.name);
            } catch (error) {
                console.error(`Error fetching ${table}:`, error);
                return [];
            }
        }

        async function saveTypesList(table, typesArray) {
            try {
                // Delete all existing records
                await supabase.from(table).delete().neq('id', 0); // Delete all
                
                // Insert new records
                const records = typesArray.map(name => ({ name }));
                const { error } = await supabase.from(table).insert(records);
                
                if (error) throw error;
                showNotification(`${table} updated successfully`, 'success');
            } catch (error) {
                console.error(`Error saving ${table}:`, error);
                showNotification(`Error saving ${table}: ${error.message}`, 'error');
            }
        }

        // --- Initial Load Functions ---

        async function loadAllDataAndRefreshUI() {
            showNotification('Loading data from Supabase...', 'info');
            
            // Fetch everything
            await fetchSafes();
            await fetchTransactions('expenses');
            await fetchTransactions('incomes');
            await fetchTransactions('transfers');
            
            // Fetch types
            appState.expenseTypes = await fetchTypes('expense_types');
            appState.expenseSubTypes = await fetchTypes('expense_sub_types');
            appState.incomeTypes = await fetchTypes('income_types');
            appState.incomeSubTypes = await fetchTypes('income_sub_types');

            // Find latest ID for navigation number generation
            appState.latestExpenseNumber = appState.expenses.length > 0 ? Math.max(...appState.expenses.map(e => e.id)) : 0;
            appState.latestIncomeNumber = appState.incomes.length > 0 ? Math.max(...appState.incomes.map(i => i.id)) : 0;
            
            // Refresh UI components
            updateBalanceDisplay();
            loadSafes();
            loadExpenseTypes();
            loadIncomeTypes();
            loadTransfersList();
            
            // Display current record
            displayExpenseRecord(appState.currentExpenseIndex === -1 ? appState.expenses.length - 1 : appState.currentExpenseIndex);
            displayIncomeRecord(appState.currentIncomeIndex === -1 ? appState.incomes.length - 1 : appState.currentIncomeIndex);
            displayTransferRecord(appState.currentTransferIndex === -1 ? appState.transfers.length - 1 : appState.currentTransferIndex);
            displaySafeRecord(appState.currentSafeIndex === -1 ? appState.safes.length - 1 : appState.currentSafeIndex);

            // Populate settings textareas
            document.getElementById('expense-types-list').value = appState.expenseTypes.join(', ');
            document.getElementById('expense-sub-types-list').value = appState.expenseSubTypes.join(', ');
            document.getElementById('income-types-list').value = appState.incomeTypes.join(', ');
            document.getElementById('income-sub-types-list').value = appState.incomeSubTypes.join(', ');

            showNotification('Data synchronization complete', 'success');
        }

        // --- UI Update & Loaders (Modified to use appState) ---

        function updateBalanceDisplay() {
            let totalBalance = 0;
            let totalExpenses = 0;
            
            appState.safes.forEach(safe => {
                totalBalance += parseFloat(safe.current_balance) || 0;
            });
            
            appState.expenses.forEach(expense => {
                totalExpenses += parseFloat(expense.value) || 0;
            });

            document.getElementById('net-balance').textContent = formatCurrency(totalBalance);
            document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);

            // Update safe balances
            if (appState.safes.length > 0) {
                document.getElementById('balance-safe1').textContent = formatCurrency(appState.safes[0].current_balance);
                document.getElementById('balance-safe1').className = `amount ${appState.safes[0].current_balance >= 0 ? 'positive' : 'negative'}`;
            } else {
                document.getElementById('balance-safe1').textContent = formatCurrency(0);
                document.getElementById('balance-safe1').className = `amount positive`;
            }

            if (appState.safes.length > 1) {
                document.getElementById('balance-safe2').textContent = formatCurrency(appState.safes[1].current_balance);
                document.getElementById('balance-safe2').className = `amount ${appState.safes[1].current_balance >= 0 ? 'positive' : 'negative'}`;
            } else {
                document.getElementById('balance-safe2').textContent = formatCurrency(0);
                document.getElementById('balance-safe2').className = `amount positive`;
            }

            document.getElementById('net-balance').className = `amount ${totalBalance >= 0 ? 'positive' : 'negative'}`;
        }
        
        function loadSafes() {
            const safeSelects = [
                document.getElementById('expense-safe'),
                document.getElementById('income-safe'),
                document.getElementById('transfer-from'),
                document.getElementById('transfer-to'),
                document.getElementById('all-safes')
            ];

            safeSelects.forEach(select => {
                // Keep the first option (placeholder) if it exists
                const initialOption = select.querySelector('option[value=""]');
                select.innerHTML = '';
                if (initialOption) {
                    select.appendChild(initialOption);
                }

                // Add safes as options
                appState.safes.forEach(safe => {
                    const option = document.createElement('option');
                    option.value = safe.name;
                    option.textContent = `${safe.name} (${formatCurrency(safe.current_balance)})`;
                    select.appendChild(option);
                });
            });

            // Also update the all-safes select (for settings)
            const allSafesSelect = document.getElementById('all-safes');
            allSafesSelect.innerHTML = '';
            appState.safes.forEach(safe => {
                const option = document.createElement('option');
                option.value = safe.id; // Use ID for selection in settings
                option.textContent = `${safe.name} - Balance: ${formatCurrency(safe.current_balance)}`;
                allSafesSelect.appendChild(option);
            });
        }
        
        function loadExpenseTypes() {
            const datalist = document.getElementById('expense-main-types');
            const subDatalist = document.getElementById('expense-sub-types');
            const reportMainType = document.getElementById('report-main-type');
            const reportSubType = document.getElementById('report-sub-type');

            // Populate datalists
            datalist.innerHTML = '';
            appState.expenseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                if (isArabicText(type)) { option.className = 'arabic-text'; option.dir = 'rtl'; }
                datalist.appendChild(option);
            });

            subDatalist.innerHTML = '';
            appState.expenseSubTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                if (isArabicText(type)) { option.className = 'arabic-text'; option.dir = 'rtl'; }
                subDatalist.appendChild(option);
            });
            
            // Populate report main type filter
            while (reportMainType.options.length > 1) { reportMainType.remove(1); }
            appState.expenseTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type; option.textContent = type; reportMainType.appendChild(option);
            });

            // Populate report sub type filter (Clear first, then add all expense and income sub types)
            while (reportSubType.options.length > 1) { reportSubType.remove(1); }
            [...appState.expenseSubTypes, ...appState.incomeSubTypes].forEach(type => {
                const option = document.createElement('option');
                option.value = type; option.textContent = type; reportSubType.appendChild(option);
            });
        }
        
        function loadIncomeTypes() {
            const datalist = document.getElementById('income-main-types');
            const subDatalist = document.getElementById('income-sub-types');

            // Populate datalists
            datalist.innerHTML = '';
            appState.incomeTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                if (isArabicText(type)) { option.className = 'arabic-text'; option.dir = 'rtl'; }
                datalist.appendChild(option);
            });

            subDatalist.innerHTML = '';
            appState.incomeSubTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                if (isArabicText(type)) { option.className = 'arabic-text'; option.dir = 'rtl'; }
                subDatalist.appendChild(option);
            });
        }

        function loadTransfersList() {
            const transfers = appState.transfers;
            const tableBody = document.getElementById('transfers-table-body');
            tableBody.innerHTML = '';

            if (transfers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" style="text-align: center;">No transfers recorded yet</td>`;
                tableBody.appendChild(row);
                return;
            }

            transfers.forEach(transfer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transfer.date}</td>
                    <td>${transfer.from_safe}</td>
                    <td>${transfer.to_safe}</td>
                    <td>${formatCurrency(transfer.value)}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="displayTransferRecordById(${transfer.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTransferTransaction(${transfer.id})">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- Navigation Functions (Modified for Supabase Data Structure) ---

        function displayExpenseRecord(index) {
            const expenses = appState.expenses;
            if (expenses.length === 0) {
                // Clear form for new expense
                document.getElementById('expense-number').value = `E-NEW`;
                document.getElementById('expense-date').value = getTodayDate();
                document.getElementById('expense-value').value = '2400';
                document.getElementById('expense-main-type').value = 'ŸÖÿµÿßÿ±ŸäŸÅ ÿπŸÖÿßÿ±ÿ©';
                document.getElementById('expense-sub-type').value = 'ÿ™ÿÆŸÑŸäŸÅ';
                document.getElementById('expense-safe').value = '';
                appState.currentExpenseIndex = -1;
                document.getElementById('expense-delete').disabled = true;
                return;
            }
            
            if (index < 0) index = 0;
            if (index >= expenses.length) index = expenses.length - 1;
            
            const expense = expenses[index];
            document.getElementById('expense-number').value = `E${expense.id}`;
            document.getElementById('expense-date').value = expense.date;
            document.getElementById('expense-value').value = expense.value;
            document.getElementById('expense-main-type').value = expense.main_type;
            document.getElementById('expense-sub-type').value = expense.sub_type;
            document.getElementById('expense-safe').value = expense.safe_name;
            
            appState.currentExpenseIndex = index;
            document.getElementById('expense-prev').disabled = index === 0;
            document.getElementById('expense-next').disabled = index === expenses.length - 1;
            document.getElementById('expense-delete').disabled = false;
        }

        function displayIncomeRecord(index) {
            const incomes = appState.incomes;
            if (incomes.length === 0) {
                // Clear form for new income
                document.getElementById('income-number').value = `I-NEW`;
                document.getElementById('income-date').value = getTodayDate();
                document.getElementById('income-value').value = '';
                document.getElementById('income-main-type').value = '';
                document.getElementById('income-sub-type').value = '';
                document.getElementById('income-safe').value = '';
                appState.currentIncomeIndex = -1;
                document.getElementById('income-delete').disabled = true;
                return;
            }
            
            if (index < 0) index = 0;
            if (index >= incomes.length) index = incomes.length - 1;
            
            const income = incomes[index];
            document.getElementById('income-number').value = `I${income.id}`;
            document.getElementById('income-date').value = income.date;
            document.getElementById('income-value').value = income.value;
            document.getElementById('income-main-type').value = income.main_type;
            document.getElementById('income-sub-type').value = income.sub_type;
            document.getElementById('income-safe').value = income.safe_name;
            
            appState.currentIncomeIndex = index;
            document.getElementById('income-prev').disabled = index === 0;
            document.getElementById('income-next').disabled = index === incomes.length - 1;
            document.getElementById('income-delete').disabled = false;
        }

        function displayTransferRecord(index) {
            const transfers = appState.transfers;
            if (transfers.length === 0 || index === -1) {
                // Clear form for new transfer
                document.getElementById('transfer-date').value = getTodayDate();
                document.getElementById('transfer-from').value = '';
                document.getElementById('transfer-to').value = '';
                document.getElementById('transfer-value').value = '';
                appState.currentTransferIndex = -1;
                document.getElementById('transfer-delete').disabled = true;
                return;
            }
            
            if (index < 0) index = 0;
            if (index >= transfers.length) index = transfers.length - 1;
            
            const transfer = transfers[index];
            document.getElementById('transfer-date').value = transfer.date;
            document.getElementById('transfer-from').value = transfer.from_safe;
            document.getElementById('transfer-to').value = transfer.to_safe;
            document.getElementById('transfer-value').value = transfer.value;
            
            appState.currentTransferIndex = index;
            document.getElementById('transfer-prev').disabled = index === 0;
            document.getElementById('transfer-next').disabled = index === transfers.length - 1;
            document.getElementById('transfer-delete').disabled = false;
        }

        function displayTransferRecordById(id) {
            const index = appState.transfers.findIndex(t => t.id === id);
            if (index !== -1) {
                displayTransferRecord(index);
            }
        }

        function displaySafeRecord(index) {
            const safes = appState.safes;
            if (safes.length === 0) {
                // Clear form for new safe
                document.getElementById('safe-name').value = '';
                document.getElementById('safe-initial-balance').value = 0;
                appState.currentSafeIndex = -1;
                document.getElementById('safe-delete').disabled = true;
                return;
            }
            
            if (index < 0) index = 0;
            if (index >= safes.length) index = safes.length - 1;
            
            const safe = safes[index];
            document.getElementById('safe-name').value = safe.name;
            document.getElementById('safe-initial-balance').value = safe.initial_balance;
            document.getElementById('all-safes').value = safe.id; // Select in dropdown
            
            appState.currentSafeIndex = index;
            document.getElementById('safe-prev').disabled = index === 0;
            document.getElementById('safe-next').disabled = index === safes.length - 1;
            document.getElementById('safe-delete').disabled = false;
        }

        // --- Save Functions (Now async, updating DB) ---

        async function saveExpense() {
            const idStr = document.getElementById('expense-number').value.replace('E', '');
            const id = idStr !== 'NEW' ? parseInt(idStr) : null;
            const date = document.getElementById('expense-date').value;
            const value = parseFloat(document.getElementById('expense-value').value);
            const mainType = document.getElementById('expense-main-type').value.trim();
            const subType = document.getElementById('expense-sub-type').value.trim();
            const safeName = document.getElementById('expense-safe').value;
            
            if (!date || isNaN(value) || value <= 0 || !mainType || !safeName) {
                showNotification('Please fill all required fields (Date, Value, Main Type, Safe)', 'error');
                return false;
            }

            const newExpense = { date, value, main_type: mainType, sub_type: subType, safe_name: safeName };
            if (id) newExpense.id = id;

            // 1. Handle old safe balance reversal for updates
            if (id) {
                const oldExpense = appState.expenses.find(e => e.id === id);
                if (oldExpense) {
                    // Restore old amount to old safe
                    await updateSafeBalance(oldExpense.safe_name, oldExpense.value, 'add');
                }
            }
            
            // 2. Save/Update record in DB
            const savedRecord = await saveTransaction('expenses', newExpense);
            if (!savedRecord) return false;

            // 3. Update new safe balance
            await updateSafeBalance(safeName, value, 'deduct');
            
            // 4. Update types if new (now handled in loadAllDataAndRefreshUI implicitly, but we can enforce save here)
            await saveTypesFromDatalist('expense_types', mainType, 'main');
            await saveTypesFromDatalist('expense_sub_types', subType, 'sub');
            
            // 5. Redisplay the new/updated record
            const savedIndex = appState.expenses.findIndex(e => e.id === savedRecord.id);
            if (savedIndex !== -1) {
                displayExpenseRecord(savedIndex);
            }

            return true;
        }

        async function saveIncome() {
            const idStr = document.getElementById('income-number').value.replace('I', '');
            const id = idStr !== 'NEW' ? parseInt(idStr) : null;
            const date = document.getElementById('income-date').value;
            const value = parseFloat(document.getElementById('income-value').value);
            const mainType = document.getElementById('income-main-type').value.trim();
            const subType = document.getElementById('income-sub-type').value.trim();
            const safeName = document.getElementById('income-safe').value;

            if (!date || isNaN(value) || value <= 0 || !mainType || !safeName) {
                showNotification('Please fill all required fields (Date, Value, Main Type, Safe)', 'error');
                return false;
            }

            const newIncome = { date, value, main_type: mainType, sub_type: subType, safe_name: safeName };
            if (id) newIncome.id = id;

            // 1. Handle old safe balance reversal for updates
            if (id) {
                const oldIncome = appState.incomes.find(i => i.id === id);
                if (oldIncome) {
                    // Deduct old amount from old safe
                    await updateSafeBalance(oldIncome.safe_name, oldIncome.value, 'deduct');
                }
            }
            
            // 2. Save/Update record in DB
            const savedRecord = await saveTransaction('incomes', newIncome);
            if (!savedRecord) return false;

            // 3. Update new safe balance
            await updateSafeBalance(safeName, value, 'add');

            // 4. Update types if new
            await saveTypesFromDatalist('income_types', mainType, 'main');
            await saveTypesFromDatalist('income_sub_types', subType, 'sub');

            // 5. Redisplay the new/updated record
            const savedIndex = appState.incomes.findIndex(i => i.id === savedRecord.id);
            if (savedIndex !== -1) {
                displayIncomeRecord(savedIndex);
            }
            
            return true;
        }
        
        async function saveTransfer() {
            const date = document.getElementById('transfer-date').value;
            const fromSafe = document.getElementById('transfer-from').value;
            const toSafe = document.getElementById('transfer-to').value;
            const value = parseFloat(document.getElementById('transfer-value').value);
            const currentTransfer = appState.transfers[appState.currentTransferIndex];
            const id = currentTransfer ? currentTransfer.id : null;

            if (!date || !fromSafe || !toSafe || isNaN(value) || value <= 0 || fromSafe === toSafe) {
                showNotification('Please fill all required fields and ensure "From" and "To" safes are different.', 'error');
                return false;
            }

            const newTransfer = { date, from_safe: fromSafe, to_safe: toSafe, value };
            if (id) newTransfer.id = id;

            // 1. Handle old balance reversal for updates
            if (id) {
                const oldTransfer = appState.transfers.find(t => t.id === id);
                if (oldTransfer) {
                    // Reverse old transfer: Deduct from 'to' and add to 'from'
                    await updateSafeBalance(oldTransfer.to_safe, oldTransfer.value, 'deduct');
                    await updateSafeBalance(oldTransfer.from_safe, oldTransfer.value, 'add');
                }
            }
            
            // 2. Save/Update record in DB
            const savedRecord = await saveTransaction('transfers', newTransfer);
            if (!savedRecord) return false;

            // 3. Apply the new transfer to safe balances
            await updateSafeBalance(fromSafe, value, 'deduct');
            await updateSafeBalance(toSafe, value, 'add');

            // 4. Redisplay the new/updated record
            const savedIndex = appState.transfers.findIndex(t => t.id === savedRecord.id);
            if (savedIndex !== -1) {
                displayTransferRecord(savedIndex);
            }

            return true;
        }

        async function saveSafe() {
            const name = document.getElementById('safe-name').value.trim();
            const initialBalance = parseFloat(document.getElementById('safe-initial-balance').value);
            const currentSafe = appState.safes[appState.currentSafeIndex];
            const id = currentSafe ? currentSafe.id : null;

            if (!name || isNaN(initialBalance)) {
                showNotification('Please enter a valid safe name and initial balance', 'error');
                return false;
            }

            const safeData = { name, initial_balance: initialBalance };
            if (id) safeData.id = id;
            
            // In a real application, updating initial_balance would require recalculating current_balance based on all transactions.
            // For simplicity here, we only update the name and initial balance fields. current_balance is updated in transactions.
            
            return await saveSafeRecord(safeData);
        }

        async function saveTypesFromDatalist(table, newType, typeOfList) {
            // Function to save a new type directly to DB if it's not already there
            const typeList = typeOfList === 'main' ? appState.expenseTypes : appState.expenseSubTypes;
            if (newType && !typeList.includes(newType)) {
                try {
                    const { error } = await supabase.from(table).insert({ name: newType });
                    if (!error) {
                        showNotification(`New ${typeOfList} type "${newType}" added.`, 'info');
                    }
                } catch (error) {
                    console.error(`Error adding new type to ${table}:`, error);
                }
            }
        }

        // --- Delete Functions (Now async, updating DB) ---

        async function deleteExpense() {
            const expenseToDelete = appState.expenses[appState.currentExpenseIndex];
            if (!expenseToDelete) return showNotification('No expense to delete', 'error');

            // 1. Restore balance to safe
            await updateSafeBalance(expenseToDelete.safe_name, expenseToDelete.value, 'add');

            // 2. Delete from DB
            await deleteTransaction('expenses', expenseToDelete.id);
            
            // 3. Update index and redisplay
            appState.currentExpenseIndex = Math.min(appState.currentExpenseIndex, appState.expenses.length - 1);
            displayExpenseRecord(appState.currentExpenseIndex);
        }

        async function deleteIncome() {
            const incomeToDelete = appState.incomes[appState.currentIncomeIndex];
            if (!incomeToDelete) return showNotification('No income to delete', 'error');

            // 1. Deduct balance from safe
            await updateSafeBalance(incomeToDelete.safe_name, incomeToDelete.value, 'deduct');

            // 2. Delete from DB
            await deleteTransaction('incomes', incomeToDelete.id);
            
            // 3. Update index and redisplay
            appState.currentIncomeIndex = Math.min(appState.currentIncomeIndex, appState.incomes.length - 1);
            displayIncomeRecord(appState.currentIncomeIndex);
        }

        async function deleteTransferTransaction(id) {
            const transferToDelete = appState.transfers.find(t => t.id === id);
            if (!transferToDelete) return showNotification('Transfer not found', 'error');

            // 1. Reverse the transfer
            await updateSafeBalance(transferToDelete.from_safe, transferToDelete.value, 'add'); // Add back to from_safe
            await updateSafeBalance(transferToDelete.to_safe, transferToDelete.value, 'deduct'); // Deduct from to_safe

            // 2. Delete from DB
            await deleteTransaction('transfers', id);
            
            // 3. Update index and redisplay
            appState.currentTransferIndex = Math.min(appState.currentTransferIndex, appState.transfers.length - 1);
            displayTransferRecord(appState.currentTransferIndex);
        }

        async function deleteSafe() {
            const safeToDelete = appState.safes[appState.currentSafeIndex];
            if (!safeToDelete) return showNotification('No safe selected to delete', 'error');
            
            if (!confirm(`Are you sure you want to delete safe "${safeToDelete.name}"? This is permanent and may leave transactions referencing a non-existent safe.`)) return;

            // 1. Delete from DB
            await deleteSafeRecord(safeToDelete.id);

            // 2. Update index and redisplay
            appState.currentSafeIndex = Math.min(appState.currentSafeIndex, appState.safes.length - 1);
            displaySafeRecord(appState.currentSafeIndex);
        }

        // --- Report Functions (Modified to use appState data) ---
        
        function runExpenseReport() {
            const fromDate = document.getElementById('report-from-date').value;
            const toDate = document.getElementById('report-to-date').value;
            const mainTypeFilter = document.getElementById('report-main-type').value;
            const subTypeFilter = document.getElementById('report-sub-type').value;

            // Filter the in-memory data
            const filteredData = appState.expenses.filter(expense => {
                let matches = true;
                if (fromDate && expense.date < fromDate) matches = false;
                if (toDate && expense.date > toDate) matches = false;
                if (mainTypeFilter && expense.main_type !== mainTypeFilter) matches = false;
                if (subTypeFilter && expense.sub_type !== subTypeFilter) matches = false;
                return matches;
            });

            // Group data for table
            const groupedData = {};
            filteredData.forEach(item => {
                const key = item.main_type;
                if (!groupedData[key]) {
                    groupedData[key] = { items: [], total: 0 };
                }
                groupedData[key].items.push(item);
                groupedData[key].total += parseFloat(item.value);
            });

            // Prepare for chart
            const chartLabels = Object.keys(groupedData);
            const chartData = chartLabels.map(label => groupedData[label].total);
            const title = `Expense Report: ${fromDate} to ${toDate}`;
            
            // Update table
            updateReportTable(groupedData, 'expense');

            // Update chart
            updateReportChart(chartLabels, chartData, title);
            showNotification(`Expense report generated for ${filteredData.length} records.`, 'success');
        }

        function runIncomeReport() {
            const fromDate = document.getElementById('report-from-date').value;
            const toDate = document.getElementById('report-to-date').value;
            const mainTypeFilter = document.getElementById('report-main-type').value;
            const subTypeFilter = document.getElementById('report-sub-type').value;

            // Filter the in-memory data
            const filteredData = appState.incomes.filter(income => {
                let matches = true;
                if (fromDate && income.date < fromDate) matches = false;
                if (toDate && income.date > toDate) matches = false;
                if (mainTypeFilter && income.main_type !== mainTypeFilter) matches = false;
                if (subTypeFilter && income.sub_type !== subTypeFilter) matches = false;
                return matches;
            });

            // Group data for table
            const groupedData = {};
            filteredData.forEach(item => {
                const key = item.main_type;
                if (!groupedData[key]) {
                    groupedData[key] = { items: [], total: 0 };
                }
                groupedData[key].items.push(item);
                groupedData[key].total += parseFloat(item.value);
            });

            // Prepare for chart
            const chartLabels = Object.keys(groupedData);
            const chartData = chartLabels.map(label => groupedData[label].total);
            const title = `Income Report: ${fromDate} to ${toDate}`;
            
            // Update table
            updateReportTable(groupedData, 'income');

            // Update chart
            updateReportChart(chartLabels, chartData, title);
            showNotification(`Income report generated for ${filteredData.length} records.`, 'success');
        }
        
        function updateReportTable(groupedData, type) {
            const tableBody = document.getElementById('report-table-body');
            tableBody.innerHTML = '';
            let grandTotal = 0;
            const sortedLabels = Object.keys(groupedData).sort((a, b) => groupedData[b].total - groupedData[a].total);

            sortedLabels.forEach(mainType => {
                const group = groupedData[mainType];
                grandTotal += group.total;

                // Group Header Row
                const headerRow = document.createElement('tr');
                headerRow.className = 'group-header';
                const arabicClass = isArabicText(mainType) ? 'report-arabic' : '';
                headerRow.innerHTML = `<td colspan="5" class="${arabicClass}" style="border-left-color: ${type === 'expense' ? '#e74c3c' : '#27ae60'};">${mainType} - Total: ${formatCurrency(group.total)}</td>`;
                tableBody.appendChild(headerRow);

                // Detail Rows
                group.items.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
                    const detailRow = document.createElement('tr');
                    detailRow.innerHTML = `
                        <td>${item.date}</td>
                        <td class="${isArabicText(item.main_type) ? 'report-arabic' : ''}">${item.main_type}</td>
                        <td class="${isArabicText(item.sub_type) ? 'report-arabic' : ''}">${item.sub_type}</td>
                        <td>${item.safe_name}</td>
                        <td style="font-weight: bold;">${formatCurrency(item.value)}</td>
                    `;
                    tableBody.appendChild(detailRow);
                });
            });

            // Grand Total Row
            const totalRow = document.createElement('tr');
            totalRow.className = 'group-total';
            totalRow.innerHTML = `
                <td colspan="4" style="text-align: right; font-size: 1.2em;">GRAND TOTAL</td>
                <td style="font-weight: bold; font-size: 1.2em;">${formatCurrency(grandTotal)}</td>
            `;
            tableBody.appendChild(totalRow);
        }

        // Existing chart and utility functions remain the same (updateReportChart, generateColors, clearReport, etc.)

        function updateReportChart(labels, data, title) {
            if (appState.chartInstance) {
                appState.chartInstance.destroy();
            }
            
            const ctx = document.getElementById('report-chart').getContext('2d');
            const colors = generateColors(data.length);

            appState.chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 15,
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold',
                                    family: isArabicText(labels.join(' ')) ? 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif' : 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: title,
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            },
                            titleFont: { weight: 'bold' },
                            bodyFont: { weight: 'bold' }
                        }
                    }
                }
            });
        }

        function generateColors(count) {
            const colors = [ 
                '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad', 
                '#2c3e50', '#f1c40f', '#e67e22', '#7f8c8d', '#34495e' 
            ];
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        function clearReport() {
            // Set date range to current month
            const firstDay = new Date();
            firstDay.setDate(1);
            const lastDay = new Date();
            
            document.getElementById('report-from-date').value = firstDay.toISOString().split('T')[0];
            document.getElementById('report-to-date').value = lastDay.toISOString().split('T')[0];
            
            document.getElementById('report-main-type').value = '';
            document.getElementById('report-sub-type').value = '';

            document.getElementById('report-table-body').innerHTML = '';

            if (appState.chartInstance) {
                appState.chartInstance.destroy();
                appState.chartInstance = null;
            }
            showNotification('Report filters cleared', 'info');
        }

        // --- Settings Functions (Modified for Supabase Types) ---

        async function saveExpenseTypes() {
            const mainTypes = document.getElementById('expense-types-list').value.split(',').map(t => t.trim()).filter(t => t);
            const subTypes = document.getElementById('expense-sub-types-list').value.split(',').map(t => t.trim()).filter(t => t);
            
            await saveTypesList('expense_types', mainTypes);
            await saveTypesList('expense_sub_types', subTypes);

            // Re-fetch and reload UI components
            appState.expenseTypes = await fetchTypes('expense_types');
            appState.expenseSubTypes = await fetchTypes('expense_sub_types');
            loadExpenseTypes();
            loadIncomeTypes(); // To update sub-type list
            showNotification('Expense types saved and reloaded.', 'success');
        }

        async function saveIncomeTypes() {
            const mainTypes = document.getElementById('income-types-list').value.split(',').map(t => t.trim()).filter(t => t);
            const subTypes = document.getElementById('income-sub-types-list').value.split(',').map(t => t.trim()).filter(t => t);
            
            await saveTypesList('income_types', mainTypes);
            await saveTypesList('income_sub_types', subTypes);

            // Re-fetch and reload UI components
            appState.incomeTypes = await fetchTypes('income_types');
            appState.incomeSubTypes = await fetchTypes('income_sub_types');
            loadIncomeTypes();
            loadExpenseTypes(); // To update sub-type list
            showNotification('Income types saved and reloaded.', 'success');
        }
        
        function saveCurrencySettings() {
             const newCurrency = document.getElementById('currency-symbol').value.trim() || '$';
             appState.currency = newCurrency;
             localStorage.setItem('currency', newCurrency);
             updateBalanceDisplay(); // Refresh display with new currency symbol
             showNotification(`Currency symbol updated to ${newCurrency}.`, 'success');
        }
        
        // --- Event Listeners and Initializers (Modified) ---

        function setupEventListeners() {
            // Menu buttons
            document.querySelectorAll('.main-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.main-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.submenu-container').forEach(submenu => submenu.classList.remove('active'));
                    const submenuId = this.getAttribute('data-submenu') + '-submenu';
                    const submenuElement = document.getElementById(submenuId);
                    if (submenuElement) {
                        submenuElement.classList.add('active');
                    }
                });
            });

            // Expense buttons
            document.getElementById('expense-new').addEventListener('click', () => displayExpenseRecord(-1));
            document.getElementById('expense-save').addEventListener('click', saveExpense);
            document.getElementById('expense-delete').addEventListener('click', deleteExpense);
            document.getElementById('expense-prev').addEventListener('click', () => displayExpenseRecord(appState.currentExpenseIndex - 1));
            document.getElementById('expense-next').addEventListener('click', () => displayExpenseRecord(appState.currentExpenseIndex + 1));
            
            // Income buttons
            document.getElementById('income-new').addEventListener('click', () => displayIncomeRecord(-1));
            document.getElementById('income-save').addEventListener('click', saveIncome);
            document.getElementById('income-delete').addEventListener('click', deleteIncome);
            document.getElementById('income-prev').addEventListener('click', () => displayIncomeRecord(appState.currentIncomeIndex - 1));
            document.getElementById('income-next').addEventListener('click', () => displayIncomeRecord(appState.currentIncomeIndex + 1));

            // Transfer buttons
            document.getElementById('transfer-new').addEventListener('click', () => displayTransferRecord(-1));
            document.getElementById('transfer-save').addEventListener('click', saveTransfer);
            document.getElementById('transfer-delete').addEventListener('click', () => deleteTransferTransaction(appState.transfers[appState.currentTransferIndex].id));
            document.getElementById('transfer-prev').addEventListener('click', () => displayTransferRecord(appState.currentTransferIndex - 1));
            document.getElementById('transfer-next').addEventListener('click', () => displayTransferRecord(appState.currentTransferIndex + 1));

            // Reports buttons
            document.getElementById('report-expense').addEventListener('click', runExpenseReport);
            document.getElementById('report-income').addEventListener('click', runIncomeReport);
            document.getElementById('report-clear').addEventListener('click', clearReport);

            // Safes buttons
            document.getElementById('safe-new').addEventListener('click', () => displaySafeRecord(-1));
            document.getElementById('safe-save').addEventListener('click', saveSafe);
            document.getElementById('safe-delete').addEventListener('click', deleteSafe);
            document.getElementById('safe-prev').addEventListener('click', () => displaySafeRecord(appState.currentSafeIndex - 1));
            document.getElementById('safe-next').addEventListener('click', () => displaySafeRecord(appState.currentSafeIndex + 1));
            document.getElementById('all-safes').addEventListener('change', function() {
                const id = parseInt(this.value);
                const index = appState.safes.findIndex(s => s.id === id);
                displaySafeRecord(index);
            });

            // Settings buttons
            document.getElementById('save-currency').addEventListener('click', saveCurrencySettings);
            document.getElementById('save-expense-types').addEventListener('click', saveExpenseTypes);
            document.getElementById('save-income-types').addEventListener('click', saveIncomeTypes);
            
            // Initializing current month filter and listeners for reports/settings
            clearReport();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Load currency setting from local storage
            appState.currency = localStorage.getItem('currency') || '$';
            document.getElementById('currency-symbol').value = appState.currency;

            // Load data from Supabase and refresh UI
            loadAllDataAndRefreshUI();

            // Set up event listeners after initial load
            setupEventListeners();
        });
        
        // --- Remaining Utility Functions (Backup/Restore/PDF/Excel) ---
        // Note: Backup/Restore will continue to use local storage structure for compatibility with the old file's functions, but data is fetched from appState which is synced with Supabase.

        function backupData() {
            try {
                const backupObject = {
                    safes: appState.safes,
                    expenses: appState.expenses,
                    incomes: appState.incomes,
                    transfers: appState.transfers,
                    expenseTypes: appState.expenseTypes,
                    expenseSubTypes: appState.expenseSubTypes,
                    incomeTypes: appState.incomeTypes,
                    incomeSubTypes: appState.incomeSubTypes,
                    currency: appState.currency,
                    backupDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(backupObject, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `financial_tracker_backup_${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Data backed up successfully to local file.', 'success');
            } catch (error) {
                console.error("Error during backup:", error);
                showNotification('Error during backup: ' + error.message, 'error');
            }
        }
        
        function restoreData() {
            console.log("Restore button clicked");
            document.getElementById('restore-file').click();
        }

        async function handleRestoreFile(event) {
             const file = event.target.files[0];
            if (!file) {
                console.log("No file selected");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const requiredKeys = ['safes', 'expenses', 'incomes', 'transfers'];
                    const isValid = requiredKeys.every(key => data.hasOwnProperty(key));
                    
                    if (!isValid) {
                        showNotification('Invalid backup file format', 'error');
                        return;
                    }
                    
                    document.getElementById('confirm-modal').style.display = 'flex';
                    document.getElementById('modal-confirm').onclick = async function() {
                        document.getElementById('confirm-modal').style.display = 'none';
                        await performSupabaseRestore(data);
                    };

                } catch (error) {
                    showNotification('Error parsing file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        async function performSupabaseRestore(data) {
            showNotification('Starting full data restore and overwrite...', 'warning');
            
            // Function to delete and insert records for a single table
            const restoreTable = async (tableName, records) => {
                await supabase.from(tableName).delete().neq('id', 0); // Clear table
                if (records.length > 0) {
                    // Ensure unique ID is not sent, let Supabase generate it
                    const cleanRecords = records.map(r => {
                        const { id, ...rest } = r;
                        return rest;
                    });
                    const { error } = await supabase.from(tableName).insert(cleanRecords);
                    if (error) throw new Error(`Error restoring ${tableName}: ${error.message}`);
                }
            };
            
            try {
                // 1. Restore Transactional Data (must come before safes for balance calculation)
                await restoreTable('expenses', data.expenses);
                await restoreTable('incomes', data.incomes);
                await restoreTable('transfers', data.transfers);

                // 2. Restore Safes Data (must include current_balance which should be recalculated in a real system, here we use the backup's calculated value)
                await restoreTable('safes', data.safes);
                
                // 3. Restore Types
                await restoreTable('expense_types', data.expenseTypes.map(name => ({ name })));
                await restoreTable('expense_sub_types', data.expenseSubTypes.map(name => ({ name })));
                await restoreTable('income_types', data.incomeTypes.map(name => ({ name })));
                await restoreTable('income_sub_types', data.incomeSubTypes.map(name => ({ name })));

                // 4. Restore Currency
                appState.currency = data.currency || '$';
                localStorage.setItem('currency', appState.currency);
                document.getElementById('currency-symbol').value = appState.currency;
                
                // 5. Final UI Refresh
                await loadAllDataAndRefreshUI();

                showNotification('Data successfully restored and synchronized with Supabase!', 'success');
            } catch (error) {
                console.error("Restore failed:", error);
                showNotification(`Restore failed: ${error.message}`, 'error');
            }
        }
        
        // Attach file handler to file input
        document.getElementById('restore-file').addEventListener('change', handleRestoreFile);
        document.getElementById('modal-cancel').addEventListener('click', function() {
            document.getElementById('confirm-modal').style.display = 'none';
        });

        // PDF and Excel Export functions are complex and mostly untouched, relying on appState data.
        // --- Export Functions ---
        
        // This function is the original one from the file, adapted to use appState
        function exportData() {
             try {
                const safes = appState.safes;
                const expenses = appState.expenses;
                const incomes = appState.incomes;
                const transfers = appState.transfers;

                const backupObject = {
                    safes: safes,
                    expenses: expenses,
                    incomes: incomes,
                    transfers: transfers,
                    expenseTypes: appState.expenseTypes,
                    expenseSubTypes: appState.expenseSubTypes,
                    incomeTypes: appState.incomeTypes,
                    incomeSubTypes: appState.incomeSubTypes,
                    currency: appState.currency,
                    backupDate: new Date().toISOString()
                };

                // 1. JSON Export
                const dataStr = JSON.stringify(backupObject, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `financial_tracker_data_${new Date().toISOString().slice(0, 10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Data exported successfully to JSON.', 'success');
            } catch (error) {
                console.error("Error during export:", error);
                showNotification('Error during export: ' + error.message, 'error');
            }
        }

        function printReport() {
            window.print();
        }
        
    </script>
</body>
</html>